<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Status de ARLA</title>
  <style>
    body {
      background-color: #f0f0f0;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      font-size: 36px;
      margin-bottom: 30px;
      color: #333;
    }
    .tarjetas {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin-bottom: 40px;
    }
    .tarjeta {
      width: 220px;
      height: 120px;
      border-radius: 12px;
      padding: 10px 15px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
      font-weight: bold;
    }
    .tarjeta h3 {
      margin: 0 0 10px 0;
      font-size: 18px;
    }
    .verde { background-color: #a8e6cf; color: #1b5e20; }
    .amarillo { background-color: #fff9c4; color: #f57f17; }
    .rojo { background-color: #ffcdd2; color: #b71c1c; }
    .gris { background-color: #cfd8dc; color: #263238; }

    .cuadros {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }
    .cuadro {
      width: 200px;
      height: 200px;
      border-radius: 10px;
      margin: 10px;
      padding: 15px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      align-items: center;
      background-color: #ffffff;
      border: 2px solid #ccc;
      text-align: center;
    }
    .titulo {
      font-weight: bold;
      font-size: 22px;
      color: #333;
    }
    .chofer {
      font-size: 14px;
      font-weight: bold;
      color: #444;
    }
    .chequeo {
      font-size: 16px;
      font-weight: bold;
      color: #666;
    }
    .barra-container {
      background-color: #e0e0e0;
      border-radius: 5px;
      overflow: hidden;
      height: 25px;
      width: 100%;
    }
    .barra {
      height: 25px;
      border-radius: 5px;
    }
    .raya-1 { width: 25%; background-color: #f8d7da; }
    .raya-2 { width: 50%; background-color: #ffeeba; }
    .raya-3 { width: 75%; background-color: #fff3cd; }
    .raya-4 { width: 100%; background-color: #d4edda; }

    .parpadea {
      animation: parpadeo 1.5s infinite alternate;
    }
    @keyframes parpadeo {
      0% { background-color: #fff; }
      100% { background-color: #ffcdd2; }
    }
  </style>
</head>
<body>

<h1>STATUS DE ARLA</h1>
<div class="tarjetas" id="tarjetas"></div>
<div class="cuadros" id="cuadros"></div>

<script>
  // Callback JSONP
  function handleARLA(data) {
    let tanqueLleno = 0, mitadTanque = 0, reserva = 0, sinActualizar = 0;
    const ahora = new Date();

    // Mantener sólo el registro más reciente por móvil
    const estadoPorMovil = {};
    data.forEach(entry => {
      const movil = parseInt(entry["MOVIL"], 10);
      const ts = new Date(entry["Marca temporal"]);
      if (!estadoPorMovil[movil] || ts > new Date(estadoPorMovil[movil]["Marca temporal"])) {
        estadoPorMovil[movil] = entry;
      }
    });

    Object.values(estadoPorMovil).forEach(entry => {
      const movil = entry["MOVIL"];
      const rayas = parseInt(entry["CANTIDAD DE ARLA EN RAYAS SEGUN TABLERO"], 10);
      const chofer = entry["NOMBRE Y APELLIDO"] || "—";
      const fecha = entry["Marca temporal"] || "—";

      // Contar estados
      if (rayas === 4) tanqueLleno++;
      else if (rayas === 2 || rayas === 3) mitadTanque++;
      else if (rayas === 1) reserva++;

      // +24hs sin actualizar
      const horas = (ahora - new Date(fecha)) / (1000 * 60 * 60);
      if (!isNaN(horas) && horas > 24) sinActualizar++;

      // Crear recuadro de móvil
      const cuadro = document.createElement("div");
      cuadro.className = "cuadro";
      if (rayas === 1) cuadro.classList.add("parpadea");
      cuadro.innerHTML = `
        <div class="titulo">Móvil ${movil}</div>
        <div class="chofer">Chofer: ${chofer}</div>
        <div class="chequeo">${fecha}</div>
        <div class="barra-container">
          <div class="barra raya-${rayas}"></div>
        </div>
      `;
      document.getElementById("cuadros").appendChild(cuadro);
    });

    // Actualizar tarjetas de resumen
    document.getElementById("tarjetas").innerHTML = `
      <div class="tarjeta verde">
        <h3>Tanque lleno</h3>
        ${tanqueLleno}
      </div>
      <div class="tarjeta amarillo">
        <h3>Mitad de tanque</h3>
        ${mitadTanque}
      </div>
      <div class="tarjeta rojo">
        <h3>Reserva</h3>
        ${reserva}
      </div>
      <div class="tarjeta gris">
        <h3>+24hs sin actualizar</h3>
        ${sinActualizar}
      </div>
    `;
  }
</script>

<!-- Llamada JSONP al endpoint de Apps Script -->
<script src="https://script.google.com/macros/s/AKfycbzRDaAFR2GYrlD3AkD5Uyj3q7Hy27MY6dtIZqPrlCzAs7Dc35TPMAn3UskB2kznlteoew/exec?callback=handleARLA"></script>

</body>
</html>
